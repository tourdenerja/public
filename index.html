<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tour de Nerja – Startsida</title>

<style>
:root{
  --bg:#0a0a0b;
  --text:#f4f4f5;
  --muted:#a1a1aa;
  --line:rgba(255,255,255,.12);
  --surface:rgba(255,255,255,.03);
  --radius:22px;
  --max:1080px;
  --header-h:56px;
  --anchor-offset:120px;

  --ok:#16a34a;

  --bar-bg:rgba(255,255,255,.06);
  --bar-line:rgba(255,255,255,.10);
  --bar-split:rgba(0,0,0,.55);
  --bar-mid:rgba(255,255,255,.10);

  --chip:rgba(255,255,255,.08);
  --chip2:rgba(255,255,255,.06);

  --tab-bg:rgba(255,255,255,.06);
  --tab-on:rgba(255,255,255,.12);
  --tab-line:rgba(255,255,255,.16);

  --shadow:0 20px 60px rgba(0,0,0,.55);

  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}

*{ box-sizing:border-box; }
html{ scroll-behavior:smooth; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:var(--sans);
}
a{ color:inherit; text-decoration:none; }
a:hover{ opacity:.9; }

.wrap{
  max-width:var(--max);
  margin:0 auto;
  padding:18px 14px 40px;
}

.header{
  position:sticky;
  top:0;
  z-index:50;
  height:var(--header-h);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 14px;
  background:rgba(10,10,11,.86);
  border-bottom:1px solid var(--line);
  backdrop-filter: blur(10px);
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
  letter-spacing:.2px;
}
.brand .logo{
  width:38px;
  height:38px;
  border-radius:12px;
  background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 12px 24px rgba(0,0,0,.35);
}
.nav{
  display:flex;
  gap:8px;
}
.nav a{
  padding:8px 10px;
  border-radius:12px;
  background:var(--chip2);
  border:1px solid var(--line);
  font-weight:600;
  font-size:13px;
}

.hero{
  padding:18px 2px 8px;
}
.hero h1{
  margin:10px 0 6px;
  font-size:30px;
  letter-spacing:.2px;
}
.hero .lead{
  margin:0;
  color:var(--muted);
  line-height:1.55;
}

.block{
  margin-top:14px;
  padding:14px;
  border-radius:var(--radius);
  border:1px solid var(--line);
  background:var(--surface);
  box-shadow: var(--shadow);
}
.section-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.section-title{
  font-weight:800;
  letter-spacing:.2px;
}
.section-sub{
  color:var(--muted);
  font-size:13px;
}

.scorebar{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  gap:10px;
  align-items:stretch;
  border-radius:18px;
  overflow:hidden;
  background:var(--bar-bg);
  border:1px solid var(--bar-line);
}
.bar-head{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:0;
  padding:10px 12px;
  border-bottom:1px solid var(--bar-line);
  background:rgba(255,255,255,.04);
}
.bar-team{
  font-weight:800;
  letter-spacing:.3px;
}
.bar-team.right{ text-align:right; }

.bar-mid{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0 10px;
  border-left:1px solid var(--bar-line);
  border-right:1px solid var(--bar-line);
  background:rgba(0,0,0,.25);
}

.points{
  display:grid;
  grid-template-columns: 1fr auto 1fr;
  gap:10px;
  padding:10px 12px;
}
.points .left,
.points .right{
  display:flex;
  align-items:center;
  gap:10px;
}
.points .right{
  justify-content:flex-end;
}
.pval{
  font-size:30px;
  font-weight:900;
  letter-spacing:.3px;
}
.plabel{
  color:var(--muted);
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.8px;
}
.midchip{
  padding:8px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.07);
  border:1px solid var(--bar-line);
  font-weight:800;
  font-size:13px;
}

.tabs{
  display:flex;
  gap:8px;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:12px;
}
.tab{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--tab-line);
  background:var(--tab-bg);
  font-weight:800;
  font-size:13px;
  cursor:pointer;
}
.tab[aria-selected="true"]{
  background:var(--tab-on);
}

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  overflow:hidden;
  border-radius:16px;
  border:1px solid var(--line);
}
.table th,
.table td{
  padding:10px 10px;
  border-bottom:1px solid var(--line);
  vertical-align:middle;
}
.table th{
  text-align:left;
  font-size:12px;
  color:var(--muted);
  letter-spacing:.7px;
  text-transform:uppercase;
  background:rgba(255,255,255,.03);
}
.table td{
  font-size:14px;
}
.table tr:last-child td{ border-bottom:none; }
.num{ text-align:right; font-family:var(--mono); font-variant-numeric: tabular-nums; }
.small{ font-size:12px; color:var(--muted); }

.sortable th{
  cursor:pointer;
  user-select:none;
}
.sortable th .s{
  opacity:.6;
  font-size:12px;
  margin-left:6px;
}

/* Sticky header offset for anchor scroll */
#competitionInfoBlock{ scroll-margin-top: var(--anchor-offset); }

@media (max-width:640px){
  .hero h1{ font-size:26px; }
  .pval{ font-size:26px; }
  .nav a{ font-size:12px; padding:7px 9px; }
  .block{ padding:12px; }
  .table th, .table td{ padding:9px 8px; }
}
</style>
</head>

<body>
<header class="header">
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>Tour de Nerja</div>
  </div>

  <nav class="nav" aria-label="Navigation">
    <a href="#tourdenerja">Tour de Nerja</a>
    <a href="#statsBlock">Statistik</a>
    <a href="#competitionInfoBlock">Tävlingsinformation</a>
  </nav>
</header>

<main class="wrap" id="tourdenerja">
  <section class="hero">
    <h1>Tour de Nerja 2026</h1>
    <p class="lead">
      Matchplay, lagfokus och tillräckligt många sidobet för att göra matte till en kontaktsport.
    </p>
  </section>

  <section class="block" id="scorebarBlock">
    <div class="scorebar" aria-label="Scorebar">
      <div class="bar-head" aria-label="Lag">
        <div class="bar-team" id="teamAName">Lag A</div>
        <div class="bar-team right" id="teamBName">Lag B</div>
      </div>

      <div class="points" aria-label="Poäng">
        <div class="left">
          <div>
            <div class="pval" id="teamAPoints">0</div>
            <div class="plabel">Poäng</div>
          </div>
        </div>

        <div class="bar-mid">
          <div class="midchip" id="barMidText">Totalt</div>
        </div>

        <div class="right">
          <div>
            <div class="pval" id="teamBPoints">0</div>
            <div class="plabel" style="text-align:right">Poäng</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Rounds / Matches -->
  <section class="block" id="roundsBlock">
    <div class="section-head">
      <div>
        <div class="section-title">Rundor</div>
        <div class="section-sub">Matchresultat och status</div>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Rundor" id="roundTabs"></div>
    <div id="roundContent"></div>
  </section>

  <!-- Stats -->
  <section class="block" id="statsBlock">
    <div class="section-head">
      <div>
        <div class="section-title">Statistik</div>
        <div class="section-sub">Lag och spelare</div>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Statistik" style="justify-content:center; margin-top:10px">
      <button class="tab" id="tabLag" aria-selected="true" type="button">Lag</button>
      <button class="tab" id="tabSpelare" aria-selected="false" type="button">Spelare</button>
    </div>

    <div id="lagStatsWrap"></div>
    <div id="playerStatsWrap" style="display:none"></div>

    <div class="small" style="margin-top:10px; line-height:1.55">
      <strong>Regler:</strong>
      <br>1) 1 poäng för vinst (W), 0.5 för delning (H), 0 för förlust (L).
      <br>2) Finalfördel räknas som slag till par.
      <br>3) Tiebreaker: Mest poäng, sedan flest vinster, sedan bäst plus/minus.
      <br>4) Om fortfarande lika: Flest par (P).
      <br>5) Flest eagles (E).
      <br>6) Flest birdies (B).
    </div>
  </section>

  <!-- Competition info (hidden until it has content) -->
  <section class="block" id="competitionInfoBlock" style="display:none; margin-top:14px">
    <div class="section-head" style="margin-bottom:12px">
      <div class="section-title">Tävlingsinformation</div>
    </div>
    <div id="competitionInfoContent" style="line-height:1.6;"></div>
  </section>
</main>

<script>
(() => {
  // =========================
  // STORAGE KEY
  // =========================
  const KEY = 'TDN_STATE_V1';

  // =========================
  // LOAD / SAFE HELPERS
  // =========================
  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return {};
      return JSON.parse(raw) || {};
    }catch(_){
      return {};
    }
  }

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, (m)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function fmt(n){
    const x = Number(n);
    if(!Number.isFinite(x)) return '0';
    if(Math.abs(x % 1) > 0.00001) return x.toFixed(1);
    return String(x);
  }

  // =========================
  // SCOREBAR
  // =========================
  function renderScorebar(){
    const state = loadState();
    const teamAName = document.getElementById('teamAName');
    const teamBName = document.getElementById('teamBName');
    const teamAPoints = document.getElementById('teamAPoints');
    const teamBPoints = document.getElementById('teamBPoints');

    const aName = state?.teams?.A?.name || 'Lag A';
    const bName = state?.teams?.B?.name || 'Lag B';

    const aPts = Number(state?.teams?.A?.points || 0);
    const bPts = Number(state?.teams?.B?.points || 0);

    teamAName.textContent = aName;
    teamBName.textContent = bName;
    teamAPoints.textContent = fmt(aPts);
    teamBPoints.textContent = fmt(bPts);
  }

  // =========================
  // ROUNDS / MATCHES
  // =========================
  const roundTabs = document.getElementById('roundTabs');
  const roundContent = document.getElementById('roundContent');

  function setActiveRound(roundId){
    const state = loadState();
    const rounds = Array.isArray(state.rounds) ? state.rounds.slice() : [];
    rounds.sort((a,b)=> (a.date||'').localeCompare(b.date||''));

    const active = roundId || (rounds[0] && rounds[0].id) || null;

    // tabs
    roundTabs.innerHTML = '';
    rounds.forEach((r, idx)=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'tab';
      b.textContent = r.title || `Runda ${idx+1}`;
      b.setAttribute('aria-selected', String(r.id === active));
      b.addEventListener('click', ()=> setActiveRound(r.id));
      roundTabs.appendChild(b);
    });

    // content
    renderRoundMatches(active, state);
  }

  function renderRoundMatches(roundId, state){
    const matches = Array.isArray(state.matches) ? state.matches : [];
    const list = matches.filter(m => m.roundId === roundId);

    if(!list.length){
      roundContent.innerHTML = `<div class="small" style="margin-top:10px">Inga matcher ännu.</div>`;
      return;
    }

    const html = list.map(m=>{
      const left = esc(m.leftName || '');
      const right = esc(m.rightName || '');
      const status = esc(m.status || '');
      const score = esc(m.score || '');
      const line = `<div class="small" style="margin-top:4px">${status}${score ? ' • ' + score : ''}</div>`;
      return `
        <div class="block" style="margin-top:12px; box-shadow:none">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
            <div style="font-weight:800">${left}</div>
            <div class="small" style="font-family:var(--mono)">${esc(m.matchNo ?? '')}</div>
            <div style="font-weight:800; text-align:right">${right}</div>
          </div>
          ${line}
        </div>
      `;
    }).join('');

    roundContent.innerHTML = html;
  }

  function renderRoundsAndMatches(){
    setActiveRound(null);
  }

  // =========================
  // STATS TABS
  // =========================
  const tabLag = document.getElementById('tabLag');
  const tabSpelare = document.getElementById('tabSpelare');
  const lagStatsWrap = document.getElementById('lagStatsWrap');
  const playerStatsWrap = document.getElementById('playerStatsWrap');

  function setPublicStatsTab(which){
    const isLag = which === 'lag';
    tabLag.setAttribute('aria-selected', String(isLag));
    tabSpelare.setAttribute('aria-selected', String(!isLag));
    lagStatsWrap.style.display = isLag ? '' : 'none';
    playerStatsWrap.style.display = isLag ? 'none' : '';
  }

  tabLag.addEventListener('click', ()=> setPublicStatsTab('lag'));
  tabSpelare.addEventListener('click', ()=> setPublicStatsTab('spelare'));

  // =========================
  // RENDER STATS TABLES
  // =========================
  function renderLagStats(state){
    const a = state?.teams?.A || {};
    const b = state?.teams?.B || {};
    const rows = [
      {team: a.name || 'Lag A', pts: a.points || 0},
      {team: b.name || 'Lag B', pts: b.points || 0},
    ].sort((x,y)=> Number(y.pts) - Number(x.pts));

    lagStatsWrap.innerHTML = `
      <table class="table sortable" id="lagTable">
        <thead>
          <tr>
            <th>Lag <span class="s">↕</span></th>
            <th class="num">Poäng <span class="s">↕</span></th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr>
              <td>${esc(r.team)}</td>
              <td class="num">${fmt(r.pts)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderPlayerStats(state){
    const players = Array.isArray(state.players) ? state.players.slice() : [];
    players.sort((a,b)=> (a.name||'').localeCompare(b.name||''));

    playerStatsWrap.innerHTML = `
      <table class="table sortable" id="playerTable">
        <thead>
          <tr>
            <th>Spelare <span class="s">↕</span></th>
            <th class="num">W <span class="s">↕</span></th>
            <th class="num">H <span class="s">↕</span></th>
            <th class="num">L <span class="s">↕</span></th>
            <th class="num">Poäng <span class="s">↕</span></th>
          </tr>
        </thead>
        <tbody>
          ${players.map(p=>`
            <tr>
              <td>${esc(p.name || '')}</td>
              <td class="num">${fmt(p.w || 0)}</td>
              <td class="num">${fmt(p.h || 0)}</td>
              <td class="num">${fmt(p.l || 0)}</td>
              <td class="num">${fmt(p.points || 0)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  // =========================
  // COMPETITION INFO
  // =========================
  function renderCompetitionInfo(state){
    const block = document.getElementById('competitionInfoBlock');
    const content = document.getElementById('competitionInfoContent');
    if(!block || !content) return;

    const html = (state && typeof state.competitionInfoHtml === 'string') ? state.competitionInfoHtml.trim() : '';
    if(!html){
      block.style.display = 'none';
      content.innerHTML = '';
      return;
    }

    block.style.display = '';
    content.innerHTML = html;
  }

  // =========================
  // SORTING
  // =========================
  function enableStatTableSorting(){
    document.querySelectorAll('table.sortable').forEach(table=>{
      const ths = table.querySelectorAll('thead th');
      ths.forEach((th, idx)=>{
        th.addEventListener('click', ()=>{
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const dir = th.dataset.dir === 'asc' ? 'desc' : 'asc';
          ths.forEach(x=> delete x.dataset.dir);
          th.dataset.dir = dir;

          rows.sort((r1,r2)=>{
            const a = r1.children[idx].innerText.trim();
            const b = r2.children[idx].innerText.trim();
            const na = Number(a.replace(',', '.'));
            const nb = Number(b.replace(',', '.'));
            const bothNum = Number.isFinite(na) && Number.isFinite(nb);

            let cmp;
            if(bothNum) cmp = na - nb;
            else cmp = a.localeCompare(b, 'sv');

            return dir === 'asc' ? cmp : -cmp;
          });

          rows.forEach(r=> tbody.appendChild(r));
        });
      });
    });
  }

  // =========================
  // PUBLIC RENDER
  // =========================
  function renderPublicStats(){
    const state = loadState();
    renderLagStats(state);
    renderPlayerStats(state);
    renderCompetitionInfo(state);
    enableStatTableSorting();
  }

  // =========================
  // BOOT
  // =========================
  renderScorebar();
  renderRoundsAndMatches();
  renderPublicStats();
  setPublicStatsTab('lag');

  // =========================
  // HASH / ANCHOR SUPPORT
  // =========================
  function revealAndScrollToHash(){
    const raw = (location.hash || '').trim();
    if(!raw || raw.length < 2) return;
    const id = raw.slice(1);
    const el = document.getElementById(id);
    if(!el) return;

    if(id === 'competitionInfoBlock'){
      try{
        const state = loadState();
        renderCompetitionInfo(state);
      }catch(_){}
    }

    if(window.getComputedStyle(el).display === 'none') return;
    requestAnimationFrame(()=> el.scrollIntoView({behavior:'smooth', block:'start'}));
  }

  document.addEventListener('click', (e)=>{
    const a = e.target.closest && e.target.closest('a[href^="#"]');
    if(!a) return;
    const href = a.getAttribute('href') || '';
    if(href === '#competitionInfoBlock'){
      const state = loadState();
      renderCompetitionInfo(state);
      requestAnimationFrame(()=> revealAndScrollToHash());
      e.preventDefault();
      history.pushState(null, '', href);
    }
  });

  window.addEventListener('hashchange', revealAndScrollToHash);
  revealAndScrollToHash();

  // Re-render if admin updates localStorage
  window.addEventListener('storage', (e)=>{
    if(e.key === KEY){
      renderScorebar();
      renderRoundsAndMatches();
      renderPublicStats();
    }
  });
})();
</script>
</body>
</html>
